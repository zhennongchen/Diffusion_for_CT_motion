# Diffusion-based generative model for CT motion correction
**Author: Zhennong Chen, PhD**<br />

This is the GitHub repo based on an unpublished paper: <br />
*Portable Head CT Motion Artifact Correction via Diffusion-based Generative Model*<br />
Authors: Zhennong Chen, Siyeop Yoon, Quirin Strotzer, Rehab Naeem Khalid, Matthew Tivnan, Quanzheng Li, Rajiv Gupta, Dufan Wu<br />

**Citation**: TBD

## Description
We have proposed HeadMotion-Elucidated Diffusion Model(HM-EDM), to reduce the motion artifact in 3D head CT scans.<br />
The main contributions of HM-EDM are as follows:<br />
(1) first diffusion-based generative model to tackle the motion artifact in CT, suppress performance aginst CNN-based methods.<br />
(2) utilize [Elucidated Diffusion Model framework](https://github.com/NVlabs/edm) for better performance and faster sampling. Introduce histogram equalization in the image pre-processing to balance the performance in brain tissue and skull. <br />
(3) trained on simulated CT scans (simulated motion on motion-free fixed CT images using portable CT scan geometry) and validated on real-world portable head CT scans.<br />


## User Guideline
### Environment Setup
The entire code is [containerized](https://www.docker.com/resources/what-container). This makes setting up environment swift and easy. Make sure you have nvidia-docker and Docker CE [installed](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker) on your machine before going further. <br />
- You can build your own docker from the folder ```docker```. <br />
- You need to download ```bins.npy``` and ```bins_mapped.npy```, which will be used in histogram equalization (define their path in ```utils/Generator.py```). Alternatively, you can use ```histogram_equalization.ipynb``` to generate your own version. <br />


### Data Preparation
- **paired data**<br />
    - you want to paired motion-free and motion-corrupted image (generated by FBP). A simulation example can be found in [Chen et al.](https://aapm.onlinelibrary.wiley.com/doi/abs/10.1002/mp.17047) <br />

- **Patient list** <br />
    - Please prepare a patient list as the example ```Patient_list_train_test_simulated_all_motion_v1.xlsx```. It saves the data path of your load into a spreadsheet. please write your own code to generate this.<br />

### Main
use ```main_train.py``` to train the model.  <br /> 
use ```main_sample.py``` to do the motion correction on new data <br /> 
For both , the user should fill in the blocks with "important parameters" .<br /> 

### Additional guidelines 
Please contact zchen36@mgh.harvard.edu and chenzhennong@gmail.com for any further questions.



